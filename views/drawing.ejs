<div id="drawing-area">
<canvas width="640" height="480" id="can"></canvas>
</div>

<div id="palette-area">

<div id="color-black" class="palette" onClick="changeColor('black')"></div>
<div id="color-red" class="palette" onClick="changeColor('red')"></div>
<div id="color-blue" class="palette" onClick="changeColor('blue')"></div>
<div id="color-green" class="palette" onClick="changeColor('green')"></div>

<button id="clear-button" type="button">Clear canvas</button>
</div>

<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

	var socket = io.connect();
	var can, ctx, cb;
	var mouse_condition = false;
	var data = new Array();

	var fillColor = 'black';
	
	function changeColor(color) {
		fillColor = color;
		console.log(color);
	};

	window.addEventListener( 'load', function() {
		can = document.getElementById('can');
		ctx = can.getContext('2d');
		
		cb = document.getElementById('clear-button');

		cb.addEventListener('click', function(e) {
			ctx.fillStyle = "rgb(255,255,255)";
			ctx.fillRect(0, 0, can.width, can.height);
			console.log("clear canvas");
			socket.emit('message', JSON.stringify({type: 'clear'}));
			console.log( ">>> send clear command" );
			data.length = 0;
		});
		
		can.addEventListener( 'mousemove', function(e) {
			if( mouse_condition) {
				var rect = e.target.getBoundingClientRect();
				var mex = e.clientX - rect.left;
				var mey = e.clientY - rect.top;
				
				ctx.beginPath();
				ctx.fillStyle = fillColor;
				ctx.arc( mex, mey, 5, 0, Math.PI*2, false );
				ctx.fill();
				data.push( [mex, mey] );
			}
		});

		can.addEventListener( 'mousedown', function(e) {
			mouse_condition = true;
			data.length = 0;
		});

		can.addEventListener( 'mouseup', function(e) {
			mouse_condition = false;
			var sendData = {type: 'draw',color: fillColor, pos: data};
			var msg = JSON.stringify(sendData);
			console.log( ">>>" + msg );
			socket.emit( 'message', msg);
			data.length = 0;
		});

		socket.on( 'message', function( msg ) {
			var recieveData = JSON.parse(msg);
			if(recieveData['type'] == 'draw') {
				var points = recieveData['pos'];
				var j;
	
				ctx.fillStyle = recieveData['color'];

				for( j=0; j<points.length; j++ ) {
					var p = points[j];
					ctx.beginPath();
					ctx.arc( p[0], p[1], 5, 0, Math.PI*2, false );
					ctx.fill();
				}
			}
			else if(recieveData['type'] == 'clear') {
				console.log("recieve clear command");
				ctx.fillStyle = "rgb(255,255,255)";
				ctx.fillRect(0, 0, can.width, can.height);
				data.length = 0;
			}
		});
	});
</script>
